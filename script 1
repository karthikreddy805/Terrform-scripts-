#!/bin/bash

REGION="us-east-1"
DAYS_OLD=30
CPU_THRESHOLD=10
NOW=$(date +%s)

echo "Checking for old and underutilized RDS instances..."
echo "------------------------------------------"

# Get list of RDS instances
aws rds describe-db-instances --region "$REGION" --query "DBInstances[*].[DBInstanceIdentifier,InstanceCreateTime]" --output text | while read ID CREATE_TIME; do
  CREATE_EPOCH=$(date -d "$CREATE_TIME" +%s)
  AGE_DAYS=$(( (NOW - CREATE_EPOCH) / 86400 ))

  if [ "$AGE_DAYS" -gt "$DAYS_OLD" ]; then
    echo "Instance: $ID (Age: $AGE_DAYS days)"

    # Get average CPU usage for the last 7 days
    CPU=$(aws cloudwatch get-metric-statistics \
      --region "$REGION" \
      --metric-name CPUUtilization \
      --namespace AWS/RDS \
      --statistics Average \
      --dimensions Name=DBInstanceIdentifier,Value=$ID \
      --period 604800 \
      --start-time $(date -d "-7 days" --iso-8601=seconds) \
      --end-time $(date --iso-8601=seconds) \
      --query "Datapoints[0].Average" \
      --output text)

    [ "$CPU" == "None" ] && CPU=0

    echo "   CPU Usage (7-day avg): $CPU%"

    if (( $(echo "$CPU < $CPU_THRESHOLD" | bc -l) )); then
      echo "   ⚠️  This RDS instance is old and underutilized."
    else
      echo "   ✅ This RDS instance is in use."
    fi

    echo "------------------------------------------"
  fi
done
